<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Malware</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
    <head>
      <link rel="stylesheet" type="text/css" href="../../css/global.css"></link>
      <script type="text/javascript" src="../../js/common.js"></script>
    </head>
</head>
<body>
    <div id="header"><a class="header" href="../../index.html">[]|\|[-/-\|_/\/\[]|\||)</a></div>
    <div id="content" class="content" style="width:70%;height:auto">
<header id="title-block-header">
<h1 class="title">Malware</h1>
</header>
<p>Unzip the package we get these three files.</p>
<pre><code>files.zip  __MACOSX  malware.py</code></pre>
<p>In <code>files.zip</code> are four files with name endswith <code>enc</code></p>
<pre><code>CTF-favicon.png.enc  flag.txt.enc  malware.py.enc  shopping_list.txt.enc</code></pre>
<p>AES CTR encryption take key and iv to create keystream, <code>xor</code> on keystream and plaintext to generate cipher text. So we can <code>xor</code> cipher text(<code>malware.py.enc</code>) and plain text(<code>malware.py</code>) to get keystream. Once we have the keystream, to get plain text flag we need to <code>xor</code> the encrypted flag (<code>flag.txt.enc</code>) with it.</p>
<p>The encryption script use <code>16</code> bytes for one block, so we need to truncated cipher text and plain text into list of <code>16</code> byte blocks.</p>
<pre><code>    src = [src[i:i+16] for i in range(0, len(src), 16)]
    enc = [enc[i:i+16] for i in range(0, len(enc), 16)]
    enc_flag = [enc_flag[i:i+16] for i in range(0, len(enc_flag), 16)]</code></pre>
<p>The <code>iv</code> used to create each encrypted file is increamented by one for each file, so lets say the initial value for counter is <code>v</code>, the <code>jth</code> file listed after <code>malware.py</code> would be using <code>v+j</code> for encryption.</p>
<p>As the exact order of the four files being listed is not given, we could brute-force from 1 through 3. <code>flag.txt.enc</code> is 38, so it needs 3 (round up <code>38/16</code>) blocks.</p>
<pre><code>$ wc flag.txt.enc
 0  2 38 flag.txt.enc</code></pre>
<p>Sum this up to have the following loop to output the flag.</p>
<pre><code>    for i in range(1, 4):
        flag = []
        for j in range(3):
            k = [x^y for x,y in zip(src[i+j], enc[i+j])]
            flag.extend([x^y for x,y in zip(enc_flag[j], k)])
        print(bytes(flag))</code></pre>
    </div>
    <a id="back-to-top" class="back-to-top" href="#header">TOP</a>
</body>
</html>
